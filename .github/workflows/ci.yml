name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  PDFIUM_VERSION: "7690"

jobs:
  # ===========================================================================
  # MAINTENANCE JOBS
  # Run quickly with --no-default-features --features cli.
  # The `bundled` feature is excluded here because it embeds a ~5 MB dylib;
  # these jobs are only verifying code style, tests, and docs.
  # ===========================================================================

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  lint:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --no-default-features --features cli -- -D warnings

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --lib --no-default-features --no-fail-fast

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/install-action@cargo-audit
      - run: cargo audit

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build docs
        run: cargo doc --no-deps --no-default-features --features cli
        env:
          RUSTDOCFLAGS: -D warnings
      - run: cargo test --doc --no-default-features --features cli

  msrv:
    name: MSRV Check (1.88)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.88
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --no-default-features --features cli

  # ===========================================================================
  # BUNDLED BUILD MATRIX
  # Builds the default (cli + bundled) release binary on all supported
  # platforms and architectures.  Each job:
  #   1. Downloads the correct pdfium archive for the target.
  #   2. Sets PDFIUM_BUNDLE_LIB so build.rs skips the curl auto-download.
  #   3. Runs `cargo build --release` (default features = cli + bundled).
  #   4. Verifies the binary was produced.
  # ===========================================================================

  build-bundled:
    name: Bundled Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS — Apple Silicon (arm64)
          - os: macos-latest
            target: aarch64-apple-darwin
            pdfium_asset: pdfium-mac-arm64.tgz
            lib_in_archive: lib/libpdfium.dylib

          # macOS — Intel (x86_64)
          - os: macos-13
            target: x86_64-apple-darwin
            pdfium_asset: pdfium-mac-x64.tgz
            lib_in_archive: lib/libpdfium.dylib

          # Linux — x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            pdfium_asset: pdfium-linux-x64.tgz
            lib_in_archive: lib/libpdfium.so

          # Linux — aarch64 (arm64)
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            pdfium_asset: pdfium-linux-arm64.tgz
            lib_in_archive: lib/libpdfium.so

          # Windows — x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            pdfium_asset: pdfium-win-x64.tgz
            lib_in_archive: bin/pdfium.dll

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      # Cache the extracted pdfium library between runs.
      # Key includes version + target so each platform has its own cache.
      - name: Cache pdfium library
        id: pdfium-cache
        uses: actions/cache@v4
        with:
          path: pdfium-lib
          key: pdfium-${{ env.PDFIUM_VERSION }}-${{ matrix.target }}

      # Download + extract pdfium (Unix)
      - name: Download pdfium (Unix)
        if: steps.pdfium-cache.outputs.cache-hit != 'true' && runner.os != 'Windows'
        run: |
          curl -L -f -o pdfium.tgz             "https://github.com/bblanchon/pdfium-binaries/releases/download/chromium%2F${{ env.PDFIUM_VERSION }}/${{ matrix.pdfium_asset }}"
          mkdir -p pdfium-lib
          tar xzf pdfium.tgz -C pdfium-lib
          rm pdfium.tgz

      # Download + extract pdfium (Windows)
      - name: Download pdfium (Windows)
        if: steps.pdfium-cache.outputs.cache-hit != 'true' && runner.os == 'Windows'
        shell: pwsh
        run: |
          $url = "https://github.com/bblanchon/pdfium-binaries/releases/download/chromium%2F${{ env.PDFIUM_VERSION }}/${{ matrix.pdfium_asset }}"
          Invoke-WebRequest -Uri $url -OutFile pdfium.tgz -UseBasicParsing
          New-Item -ItemType Directory -Force -Path pdfium-lib | Out-Null
          tar xzf pdfium.tgz -C pdfium-lib
          Remove-Item pdfium.tgz

      # Expose the library path to the cargo build step.
      - name: Set PDFIUM_BUNDLE_LIB (Unix)
        if: runner.os != 'Windows'
        run: echo "PDFIUM_BUNDLE_LIB=$PWD/pdfium-lib/${{ matrix.lib_in_archive }}" >> $GITHUB_ENV

      - name: Set PDFIUM_BUNDLE_LIB (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lib = Join-Path $PWD "pdfium-lib/${{ matrix.lib_in_archive }}"
          Add-Content $env:GITHUB_ENV "PDFIUM_BUNDLE_LIB=$lib"

      - uses: Swatinem/rust-cache@v2
        with:
          key: bundled-${{ matrix.target }}

      # Build the fully self-contained release binary.
      - name: Build bundled release binary
        run: cargo build --release

      # Sanity-check the produced binary.
      - name: Verify binary (Unix)
        if: runner.os != 'Windows'
        run: |
          ls -lh target/release/pdf2md
          file target/release/pdf2md

      - name: Verify binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Get-Item target/release/pdf2md.exe | Select-Object Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB,1)}}

  # ===========================================================================
  # FINAL STATUS GATE
  # All jobs above must succeed before a PR can be merged.
  # ===========================================================================

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [ format, lint, test, build-bundled, security-audit, docs, msrv ]
    if: always()
    steps:
      - name: Check CI Results
        run: |
          if [ "${{ needs.format.result }}"        != "success" ] || \
             [ "${{ needs.lint.result }}"          != "success" ] || \
             [ "${{ needs.test.result }}"          != "success" ] || \
             [ "${{ needs.build-bundled.result }}" != "success" ] || \
             [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.docs.result }}"          != "success" ] || \
             [ "${{ needs.msrv.result }}"          != "success" ]; then
            echo "CI checks failed!"
            exit 1
          fi
          echo "All CI checks passed!"
